{% extends "base.html" %}
{% load static %}

{% block title %} Страница вопроса {% endblock %}

{% block content %}

  {# CSRF для fetch #}
  <form style="display:none;">
    {% csrf_token %}
  </form>

  <div class="div-column">

    <div class="question-card">
      <div class="div-column div-column--aside">
        <img class="question-avatar" src="{{ question.user.profile.avatar_url }}" alt="" />

        {% if user.is_authenticated %}
          <div class="rating-row">
            <button
              type="button"
              class="question-mark-btn"
              data-url="{% url 'questions:question_mark' question.id %}"
              data-mark="1"
              title="Нравится"
            >
              <img class="mark-icon" src="{% static 'icons/like.svg' %}" alt="Like">
            </button>

            <input class="rating-input question-rating-input" type="number" value="{{ question.rating }}" disabled>

            <button
              type="button"
              class="question-mark-btn"
              data-url="{% url 'questions:question_mark' question.id %}"
              data-mark="-1"
              title="Не нравится"
            >
              <img class="mark-icon" src="{% static 'icons/dislike.svg' %}" alt="Dislike">
            </button>
          </div>
        {% else %}
          <input class="rating-input question-rating-input" type="number" value="{{ question.rating }}" disabled>
        {% endif %}
      </div>

      <div class="div-column div-column--main">
        {% if question.cover %}
          <p>
            <img
              src="{{ question.cover.url }}"
              alt="Обложка вопроса"
              style="max-width: 100%; height: auto; border-radius: 8px;"
            />
          </p>
        {% endif %}
        <p>{{ question.topic }}</p>
        <p>{{ question.text }}</p>
        <p>
          Тэги:
          {% for t in question.tags.all %}
            <a href="{% url 'questions:tag' t.title %}">{{ t.title }}</a>
          {% endfor %}
        </p>
      </div>
    </div>

    <hr />
    <h3>Ответы:</h3>

    {# ✅ контейнер для realtime-добавления ответов #}
    <div id="answers-container">
      {% for a in answers %}
        <div class="answer-card" id="answer-{{ a.id }}">
          <div class="div-column div-column--aside">
            <img class="question-avatar" src="{{ a.user.profile.avatar_url }}" alt="" />

            {% if user.is_authenticated %}
              <div class="rating-row">
                <button
                  type="button"
                  class="answer-mark-btn"
                  data-url="{% url 'questions:answer_mark' a.id %}"
                  data-mark="1"
                  title="Нравится"
                >
                  <img class="mark-icon" src="{% static 'icons/like.svg' %}" alt="Like">
                </button>

                <input class="rating-input answer-rating-input" type="number" value="{{ a.rating }}" disabled>

                <button
                  type="button"
                  class="answer-mark-btn"
                  data-url="{% url 'questions:answer_mark' a.id %}"
                  data-mark="-1"
                  title="Не нравится"
                >
                  <img class="mark-icon" src="{% static 'icons/dislike.svg' %}" alt="Dislike">
                </button>
              </div>
            {% else %}
              <input class="rating-input answer-rating-input" type="number" value="{{ a.rating }}" disabled>
            {% endif %}
          </div>

          <div class="div-column div-column--main">
            <p>{{ a.text }}</p>

            <p>
              {% if user.is_authenticated and user.id == question.user_id %}
                <input
                  class="answer-correct-checkbox"
                  id="correct-{{ a.id }}"
                  type="checkbox"
                  {% if a.is_correct %}checked{% endif %}
                  data-url="{% url 'questions:answer_correct' question.id %}"
                  data-answer-id="{{ a.id }}"
                >
              {% else %}
                <input
                  id="correct-{{ a.id }}"
                  type="checkbox"
                  {% if a.is_correct %}checked{% endif %}
                  disabled
                >
              {% endif %}

              <label for="correct-{{ a.id }}">Правильно</label>
            </p>
          </div>
        </div>
      {% empty %}
        <p id="answers-empty">Ответов пока нет.</p>
      {% endfor %}
    </div>

    <hr />

    <form method="post" action="{% url 'questions:answer_create' question.id %}">
      {% csrf_token %}

      <div class="answer-card user-answer-card">
        <div class="div-column--main">

          <textarea
            class="user-answer"
            name="{{ answer_form.text.name }}"
            rows="4"
            placeholder="Введите Ваш ответ"
          >{{ answer_form.text.value|default_if_none:"" }}</textarea>

          {% if answer_form.text.errors %}
            <div class="form-error">
              {{ answer_form.text.errors }}
            </div>
          {% endif %}

          <button type="submit"> Ответ </button>
        </div>
      </div>
    </form>

  </div>

  <script>
    function getCsrfToken() {
      const el = document.querySelector('[name=csrfmiddlewaretoken]');
      return el ? el.value : '';
    }

    // Лайк/дизлайк ВОПРОСА
    document.addEventListener("click", function (e) {
      const btn = e.target.closest(".question-mark-btn");
      if (!btn) return;

      const url = btn.dataset.url;
      const mark = btn.dataset.mark;
      const card = btn.closest(".question-card");
      const ratingInput = card.querySelector(".question-rating-input");
      const csrfToken = getCsrfToken();

      btn.disabled = true;

      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
          "X-CSRFToken": csrfToken
        },
        body: "mark=" + encodeURIComponent(mark),
        credentials: "same-origin"
      })
      .then(function (res) {
        return res.json().then(function (data) {
          return { ok: res.ok, status: res.status, data: data };
        });
      })
      .then(function (resp) {
        btn.disabled = false;

        if (!resp.ok) {
          console.log("question mark error", resp.status, resp.data);
          return;
        }

        ratingInput.value = resp.data.rating;

        const buttons = card.querySelectorAll(".question-mark-btn");
        buttons.forEach(function (b) { b.classList.remove("active"); });

        if (resp.data.mark === 1) {
          card.querySelector('.question-mark-btn[data-mark="1"]').classList.add("active");
        }
        if (resp.data.mark === -1) {
          card.querySelector('.question-mark-btn[data-mark="-1"]').classList.add("active");
        }
      })
      .catch(function (err) {
        btn.disabled = false;
        console.log("question mark error", err);
      });
    });

    // Лайк/дизлайк ОТВЕТА
    document.addEventListener("click", function (e) {
      const btn = e.target.closest(".answer-mark-btn");
      if (!btn) return;

      const url = btn.dataset.url;
      const mark = btn.dataset.mark;
      const card = btn.closest(".answer-card");
      const ratingInput = card.querySelector(".answer-rating-input");
      const csrfToken = getCsrfToken();

      btn.disabled = true;

      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
          "X-CSRFToken": csrfToken
        },
        body: "mark=" + encodeURIComponent(mark),
        credentials: "same-origin"
      })
      .then(function (res) {
        return res.json().then(function (data) {
          return { ok: res.ok, status: res.status, data: data };
        });
      })
      .then(function (resp) {
        btn.disabled = false;

        if (!resp.ok) {
          console.log("answer mark error", resp.status, resp.data);
          return;
        }

        ratingInput.value = resp.data.rating;

        const buttons = card.querySelectorAll(".answer-mark-btn");
        buttons.forEach(function (b) { b.classList.remove("active"); });

        if (resp.data.mark === 1) {
          card.querySelector('.answer-mark-btn[data-mark="1"]').classList.add("active");
        }
        if (resp.data.mark === -1) {
          card.querySelector('.answer-mark-btn[data-mark="-1"]').classList.add("active");
        }
      })
      .catch(function (err) {
        btn.disabled = false;
        console.log("answer mark error", err);
      });
    });

    // Выбор правильного ответа
    document.addEventListener("click", function (e) {
      const cb = e.target.closest(".answer-correct-checkbox");
      if (!cb) return;

      e.preventDefault();

      const url = cb.dataset.url;
      const answerId = cb.dataset.answerId;
      const csrfToken = getCsrfToken();

      cb.disabled = true;

      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
          "X-CSRFToken": csrfToken
        },
        body: "answer_id=" + encodeURIComponent(answerId),
        credentials: "same-origin"
      })
      .then(function (res) {
        return res.json().then(function (data) {
          return { ok: res.ok, status: res.status, data: data };
        });
      })
      .then(function (resp) {
        cb.disabled = false;

        if (!resp.ok) {
          console.log("correct error", resp.status, resp.data);
          return;
        }

        const all = document.querySelectorAll(".answer-correct-checkbox");
        all.forEach(function (x) { x.checked = false; });

        if (resp.data.answer_id && resp.data.answer_id > 0) {
          const need = document.querySelector('.answer-correct-checkbox[data-answer-id="' + resp.data.answer_id + '"]');
          if (need) need.checked = true;
        }
      })
      .catch(function (err) {
        cb.disabled = false;
        console.log("correct error", err);
      });
    });
  </script>


  {% if centrifuge_enabled %}
    <script src="https://unpkg.com/centrifuge@5.0.0/dist/centrifuge.min.js"></script>
    <script>
      (function () {
        // Настройки приходят из QuestionDetailView (centrifuge_ws_url / centrifuge_channel)
        const wsUrl = "{{ centrifuge_ws_url|escapejs }}";
        const channel = "{{ centrifuge_channel|escapejs }}";
        const tokenUrl = "{% url 'centrifuge_client:token' %}";

        function escapeHtml(s) {
          return String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function renderAnswerCard(payload) {
          const answer = payload.answer;

          const isAuth = {% if user.is_authenticated %}true{% else %}false{% endif %};
          const isOwner = {% if user.is_authenticated and user.id == question.user_id %}true{% else %}false{% endif %};

          const avatar = answer.user.avatar_url ? answer.user.avatar_url : "";
          const safeText = escapeHtml(answer.text);

          // rating controls — в точности как твоя разметка (иконки)
          let ratingControls = "";
          if (isAuth) {
            ratingControls = `
              <div class="rating-row">
                <button
                  type="button"
                  class="answer-mark-btn"
                  data-url="{% url 'questions:answer_mark' 0 %}".replace("/0/", "/" + answer.id + "/")
                  data-mark="1"
                  title="Нравится"
                >
                  <img class="mark-icon" src="{% static 'icons/like.svg' %}" alt="Like">
                </button>

                <input class="rating-input answer-rating-input" type="number" value="${answer.rating || 0}" disabled>

                <button
                  type="button"
                  class="answer-mark-btn"
                  data-url="{% url 'questions:answer_mark' 0 %}".replace("/0/", "/" + answer.id + "/")
                  data-mark="-1"
                  title="Не нравится"
                >
                  <img class="mark-icon" src="{% static 'icons/dislike.svg' %}" alt="Dislike">
                </button>
              </div>
            `;
          } else {
            ratingControls = `<input class="rating-input answer-rating-input" type="number" value="${answer.rating || 0}" disabled>`;
          }

          // correct checkbox — строго как у тебя
          const correctUrl = "{% url 'questions:answer_correct' question.id %}";
          const correctInput = isOwner
            ? `
              <input
                class="answer-correct-checkbox"
                id="correct-${answer.id}"
                type="checkbox"
                ${answer.is_correct ? "checked" : ""}
                data-url="${correctUrl}"
                data-answer-id="${answer.id}"
              >
            `
            : `
              <input
                id="correct-${answer.id}"
                type="checkbox"
                ${answer.is_correct ? "checked" : ""}
                disabled
              >
            `;

          return `
            <div class="answer-card" id="answer-${answer.id}">
              <div class="div-column div-column--aside">
                <img class="question-avatar" src="${avatar}" alt="" />
                ${ratingControls}
              </div>

              <div class="div-column div-column--main">
                <p>${safeText}</p>
                <p>
                  ${correctInput}
                  <label for="correct-${answer.id}">Правильно</label>
                </p>
              </div>
            </div>
          `;
        }

        if (typeof Centrifuge === "undefined") {
          console.warn("Centrifuge JS is not loaded");
          return;
        }

        const centrifuge = new Centrifuge(wsUrl, {
          getToken: async () => {
            const r = await fetch(tokenUrl, { credentials: "same-origin" });
            if (!r.ok) throw new Error("Token request failed");
            const data = await r.json();
            return data.token;
          }
        });

        const sub = centrifuge.newSubscription(channel);

        sub.on("publication", function (ctx) {
          const data = ctx.data || {};
          if (data.type !== "answer_created") return;

          const payload = data.payload || {};
          const answer = payload.answer;
          if (!answer || !answer.id) return;

          const container = document.getElementById("answers-container");
          if (!container) return;

          // не вставляем повторно
          if (document.getElementById("answer-" + answer.id)) return;

          // убрать пустую надпись, если была
          const empty = document.getElementById("answers-empty");
          if (empty) empty.remove();

          container.insertAdjacentHTML("beforeend", renderAnswerCard(payload));
        });

        sub.subscribe();
        centrifuge.connect();
      })();
    </script>
  {% endif %}

{% endblock %}
